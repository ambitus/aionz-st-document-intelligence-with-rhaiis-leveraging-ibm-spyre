version: "3.8"

services:
  spyre-document-summarizer:
    build:
      context: .
      dockerfile: Dockerfile
      isolation: chroot
    image: localhost/spyre-document-summarizer
    container_name: spyre-document-summarizer
    security_opt:
      - seccomp=unconfined
      - label=disable
    volumes:
      - ./backend:/home/dev/Spyre_Document_Summarizer/backend
      - ./frontend:/home/dev/Spyre_Document_Summarizer/frontend
      - /run/podman/podman.sock:/run/podman/podman.sock
    working_dir: /home/dev/Spyre_Document_Summarizer
    environment:
      - REACT_APP_API_BASE_URL=${REACT_APP_API_BASE_URL:-http://129.40.90.163:8002}
    command: >
      bash -c "
        set -e;

        echo 'Starting container...';

        source /home/dev/devenv/bin/activate || true;

        pip install -q sklearn2pmml sentence_transformers colorama rouge-score || true;

        mkdir -p /home/dev/Spyre_Document_Summarizer &&
        mkdir -p /home/dev/Spyre_Document_Summarizer/logs;

        echo 'Listing project directory:' &&
        ls -l /home/dev/Spyre_Document_Summarizer;

        if [ -d /home/dev/Spyre_Document_Summarizer/frontend ]; then
          cd /home/dev/Spyre_Document_Summarizer/frontend &&
          rm -rf node_modules &&
          npm install --silent &&
          PORT=3002 npm start --silent > /home/dev/Spyre_Document_Summarizer/logs/frontend.log 2>&1 &
        else
          echo 'ERROR: frontend directory not found' > /home/dev/Spyre_Document_Summarizer/logs/frontend.log
        fi;

        if [ -d /home/dev/Spyre_Document_Summarizer/backend ]; then
          cd /home/dev/Spyre_Document_Summarizer/backend &&
          uvicorn server:app --host 0.0.0.0 --port 8002 > /home/dev/Spyre_Document_Summarizer/logs/backend.log 2>&1 &
        else
          echo 'ERROR: backend directory not found' > /home/dev/Spyre_Document_Summarizer/logs/backend.log
        fi;

        tail -f /home/dev/Spyre_Document_Summarizer/logs/frontend.log /home/dev/Spyre_Document_Summarizer/logs/backend.log
      "


    tty: true
    ports:
      - "3002:3002"
      - "8002:8002"
    networks:
      - app-network
    depends_on:
      - mongodb
      - opensearch

  mongodb:
    image: docker.io/s390x/mongo:4
    container_name: mongodb
    security_opt:
      - label=disable
    environment:
      - DISABLE_SECURITY_PLUGIN=true
    ports:
      - "27017:27017"
    networks:
      - app-network

  opensearch:
    image: phoenixsystemsag/opensearch:2.9.0
    container_name: opensearch-doc-summary
    security_opt:
      - label=disable
    environment:
      - discovery.type=single-node
      - DISABLE_SECURITY_PLUGIN=true
    ports:
      - "19200:9200"
    volumes:
      - opensearch-data:/usr/share/opensearch/data
    networks:
      - app-network

volumes:
  opensearch-data:

networks:
  app-network:
    driver: bridge
